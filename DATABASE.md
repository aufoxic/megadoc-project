# DATABASE.md
# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö MegaDoc (MySQL)

## üìå –û–±—â–∏–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è

### –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã (ID)
- –í—Å–µ ID (–≤–µ—Ç–æ–∫, —Å–æ–æ–±—â–µ–Ω–∏–π) –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω—É: `[a-zA-Z0-9_-]+`
- –ó–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã, –∫–∏—Ä–∏–ª–ª–∏—Ü—É, —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –∫—Ä–æ–º–µ –¥–µ—Ñ–∏—Å–∞ –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
- –ü—Ä–∏–º–µ—Ä—ã –≤–∞–ª–∏–¥–Ω—ã—Ö ID: `MEGADOC_CORE`, `new-feature-2025`, `task_123`

### –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–∞—Ö
- –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–µ—Ä–µ–≤–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback –Ω–∞ —è–∑—ã–∫ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
- –ü–µ—Ä–µ–≤–æ–¥—ã –º–æ–≥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—á–µ—Ä–µ–∑ API) –∏–ª–∏ –≤—Ä—É—á–Ω—É—é

### –ù–µ–∏–∑–º–µ–Ω–Ω–æ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏–∏
- –î–∞–Ω–Ω—ã–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –∏–∑ –±–∞–∑—ã
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Ö–∞–Ω–∏–∑–º soft delete (–ø–æ–º–µ—Ç–∫–∞ –æ–± —É–¥–∞–ª–µ–Ω–∏–∏)
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

## üóÇ –¢–∞–±–ª–∏—Ü—ã

### –¢–∞–±–ª–∏—Ü–∞ `branches`
–°–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Å–µ—Ö –≤–µ—Ç–∫–∞—Ö —Å–∏—Å—Ç–µ–º—ã.
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è |
| :--- | :--- | :--- | :--- |
| `id` | `VARCHAR(50)` | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤–µ—Ç–∫–∏ | `PRIMARY KEY` |
| `name` | `VARCHAR(255)` | –ù–∞–∑–≤–∞–Ω–∏–µ –≤–µ—Ç–∫–∏ (–æ—Ä–∏–≥–∏–Ω–∞–ª) | `NOT NULL` |
| `description` | `TEXT` | –û–ø–∏—Å–∞–Ω–∏–µ –≤–µ—Ç–∫–∏ (–æ—Ä–∏–≥–∏–Ω–∞–ª) | |
| `parent_id` | `VARCHAR(50)` | ID —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –≤–µ—Ç–∫–∏ | `FOREIGN KEY REFERENCES branches(id)` |
| `is_visible` | `BOOLEAN` | –§–ª–∞–≥ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≤–µ—Ç–∫–∏ | `DEFAULT TRUE` |
| `sort_order` | `INT` | –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ | `DEFAULT 0` |
| `created_at` | `DATETIME` | –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è | `DEFAULT CURRENT_TIMESTAMP` |
| `updated_at` | `DATETIME` | –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` |
| `created_by` | `BIGINT` | user_id —Å–æ–∑–¥–∞—Ç–µ–ª—è –≤–µ—Ç–∫–∏ | `NOT NULL` |

### –¢–∞–±–ª–∏—Ü–∞ `branch_translations`
–ü–µ—Ä–µ–≤–æ–¥–∏–º—ã–µ –ø–æ–ª—è –¥–ª—è –≤–µ—Ç–æ–∫.
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è |
| :--- | :--- | :--- | :--- |
| `branch_id` | `VARCHAR(50)` | ID –≤–µ—Ç–∫–∏ | `FOREIGN KEY, PRIMARY KEY` |
| `language_code` | `VARCHAR(5)` | –ö–æ–¥ —è–∑—ã–∫–∞ | `PRIMARY KEY, FOREIGN KEY REFERENCES languages(code)` |
| `name` | `VARCHAR(255)` | –ü–µ—Ä–µ–≤–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏—è | |
| `description` | `TEXT` | –ü–µ—Ä–µ–≤–æ–¥ –æ–ø–∏—Å–∞–Ω–∏—è | |

### –¢–∞–±–ª–∏—Ü–∞ `messages`
–•—Ä–∞–Ω–∏—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ –≤–µ—Ç–∫–∞–º.
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è |
| :--- | :--- | :--- | :--- |
| `id` | `VARCHAR(255)` | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–æ–±—â–µ–Ω–∏—è (UUID) | `PRIMARY KEY` |
| `branch_id` | `VARCHAR(50)` | ID –≤–µ—Ç–∫–∏ | `FOREIGN KEY NOT NULL` |
| `user_id` | `BIGINT` | user_id –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è | `NOT NULL` |
| `content` | `TEXT` | –¢–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è | `NOT NULL` |
| `type` | `ENUM('message','decision','problem','idea')` | –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è | `DEFAULT 'message'` |
| `reply_to_id` | `VARCHAR(255)` | ID —Å–æ–æ–±—â–µ–Ω–∏—è-–æ—Ä–∏–≥–∏–Ω–∞–ª–∞ | `FOREIGN KEY` |
| `timestamp` | `DATETIME` | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è | `DEFAULT CURRENT_TIMESTAMP` |
| `is_edited` | `BOOLEAN` | –§–ª–∞–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è | `DEFAULT FALSE` |
| `is_deleted` | `BOOLEAN` | –§–ª–∞–≥ —É–¥–∞–ª–µ–Ω–∏—è (soft delete) | `DEFAULT FALSE` |
| `original_content` | `TEXT` | –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è | |
| `edited_at` | `DATETIME` | –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è | |

### –¢–∞–±–ª–∏—Ü–∞ `message_translations`
–ü–µ—Ä–µ–≤–æ–¥–∏–º—ã–µ –ø–æ–ª—è –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π.
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è |
| :--- | :--- | :--- | :--- |
| `message_id` | `VARCHAR(255)` | ID —Å–æ–æ–±—â–µ–Ω–∏—è | `FOREIGN KEY, PRIMARY KEY` |
| `language_code` | `VARCHAR(5)` | –ö–æ–¥ —è–∑—ã–∫–∞ | `PRIMARY KEY, FOREIGN KEY REFERENCES languages(code)` |
| `content` | `TEXT` | –ü–µ—Ä–µ–≤–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ | |

### –¢–∞–±–ª–∏—Ü–∞ `users`
–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –±–æ—Ç–∞.
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | user_id –∏–∑ Telegram | `PRIMARY KEY` |
| `username` | `VARCHAR(255)` | @username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | |
| `first_name` | `VARCHAR(255)` | –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | |
| `role` | `ENUM('admin','moderator','user')` | –†–æ–ª—å –≤ —Å–∏—Å—Ç–µ–º–µ | `DEFAULT 'user'` |
| `language_code` | `VARCHAR(5)` | –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π —è–∑—ã–∫ | `FOREIGN KEY REFERENCES languages(code)` |

### –¢–∞–±–ª–∏—Ü–∞ `languages`
–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —è–∑—ã–∫–æ–≤.
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è |
| :--- | :--- | :--- | :--- |
| `code` | `VARCHAR(5)` | –ö–æ–¥ —è–∑—ã–∫–∞ (ru, en, zh, etc.) | `PRIMARY KEY` |
| `name` | `VARCHAR(50)` | –ù–∞–∑–≤–∞–Ω–∏–µ —è–∑—ã–∫–∞ | `NOT NULL` |
| `is_active` | `BOOLEAN` | –§–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —è–∑—ã–∫–∞ | `DEFAULT TRUE` |

### –¢–∞–±–ª–∏—Ü–∞ `branch_tags`
–°–≤—è–∑—å "–º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º" –º–µ–∂–¥—É –≤–µ—Ç–∫–∞–º–∏ –∏ —Ç–µ–≥–∞–º–∏.
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è |
| :--- | :--- | :--- | :--- |
| `branch_id` | `VARCHAR(50)` | ID –≤–µ—Ç–∫–∏ | `FOREIGN KEY, PRIMARY KEY` |
| `tag` | `VARCHAR(255)` | –¢–µ–∫—Å—Ç —Ç–µ–≥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "#KAP") | `PRIMARY KEY` |

## ‚öôÔ∏è –¢—Ä–∏–≥–≥–µ—Ä—ã –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã

-   **`prevent_cyclic_branch`**: –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ —Å–≤—è–∑–∏ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º `parent_id`
-   **`update_branch_children`**: –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –¥–ª—è –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—á–µ—Ä–Ω–∏—Ö –≤–µ—Ç–æ–∫
-   **`save_message_history`**: –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

## üîó –°–≤—è–∑–∏ –∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

-   –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–µ—Ç–∫–∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã –∏ —Ç–µ–≥–∏ –¥–æ–ª–∂–Ω—ã —É–¥–∞–ª—è—Ç—å—Å—è (`ON DELETE CASCADE`)
-   –ü–æ–ª–µ `parent_id` –¥–æ–ª–∂–Ω–æ —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –≤–µ—Ç–∫—É –∏–ª–∏ –±—ã—Ç—å `NULL`
-   –í—Å–µ –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å properly indexed –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## üåê –ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏

1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
   - –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–æ–Ω—Ç–∞–∫—Ç–µ —Å –±–æ—Ç–æ–º –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–æ–ª–µ `users.language_code`
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–º–µ–Ω–∏—Ç—å —è–∑—ã–∫ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É `/language`

2. **–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:**
   - –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –¥–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç –ø–µ—Ä–µ–≤–æ–¥ –¥–ª—è —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ï—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
   - –í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –ø–æ–º–µ—Ç–∫–∞ "–ø–µ—Ä–µ–≤–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω" –¥–ª—è –Ω–µ–ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

3. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–æ–≤:**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å API –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫–æ–≤ (Yandex, Google, OpenAI)
   - –í—Ä—É—á–Ω—É—é: —á–µ—Ä–µ–∑ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø—Ä–∞–≤–æ–∫

## üöÄ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

-- –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≤–µ—Ç–∫–∏ —Å –∞–Ω–≥–ª–∏–π—Å–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º
INSERT INTO branches (id, name, description, created_by)
VALUES ('new_feature', 'New Feature', 'Description of new feature', 123456789);

-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä—É—Å—Å–∫–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞ –¥–ª—è –≤–µ—Ç–∫–∏
INSERT INTO branch_translations (branch_id, language_code, name, description)
VALUES ('new_feature', 'ru', '–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è', '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏');

-- –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT 
  COALESCE(bt.name, b.name) as name,
  COALESCE(bt.description, b.description) as description
FROM branches b
LEFT JOIN branch_translations bt ON b.id = bt.branch_id AND bt.language_code = 'ru'
WHERE b.id = 'new_feature';
